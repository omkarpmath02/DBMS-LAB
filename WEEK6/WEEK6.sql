-- create database and use it
CREATE DATABASE weeknew6;
USE weeknew6;


CREATE TABLE DEPT (
  DEPTNO INT PRIMARY KEY,
  DNAME VARCHAR(50),
  DLOC VARCHAR(50)
);

CREATE TABLE EMPLOYEE (
  EMPNO INT PRIMARY KEY,
  ENAME VARCHAR(50),
  MGR_NO INT,
  HIREDATE DATE,
  SAL DECIMAL(10,2),
  DEPTNO INT,
  FOREIGN KEY (DEPTNO) REFERENCES DEPT(DEPTNO)
);

CREATE TABLE PROJECT (
  PNO INT PRIMARY KEY,
  PNAME VARCHAR(50),
  PLOC VARCHAR(50)
);

CREATE TABLE ASSIGNED_TO (
  EMPNO INT,
  PNO INT,
  JOB_ROLE VARCHAR(50),
  PRIMARY KEY (EMPNO, PNO),
  FOREIGN KEY (EMPNO) REFERENCES EMPLOYEE(EMPNO),
  FOREIGN KEY (PNO) REFERENCES PROJECT(PNO)
);

CREATE TABLE INCENTIVES (
  EMPNO INT,
  INCENTIVE_DATE DATE,
  INCENTIVE_AMOUNT DECIMAL(10,2),
  FOREIGN KEY (EMPNO) REFERENCES EMPLOYEE(EMPNO)
);


INSERT INTO DEPT (DEPTNO, DNAME, DLOC) VALUES
(10, 'HR', 'Bengaluru'),
(20, 'Finance', 'Hyderabad'),
(30, 'Engineering', 'Mysuru'),
(40, 'Marketing', 'Chennai'),
(50, 'Operations', 'Delhi');


INSERT INTO EMPLOYEE (EMPNO, ENAME, MGR_NO, HIREDATE, SAL, DEPTNO) VALUES
(1001, 'Amit', 2001, '2020-01-15', 60000.00, 10),
(1002, 'Priya', 2002, '2019-03-22', 75000.00, 20),
(1003, 'Rahul', 2001, '2021-07-10', 80000.00, 30),
(1004, 'Sneha', 2003, '2022-11-05', 55000.00, 40),
(1005, 'Kiran', 2002, '2020-06-18', 72000.00, 50),
(2001, 'Ravi', NULL, '2018-01-01', 90000.00, 10),
(2002, 'Meena', NULL, '2017-05-10', 95000.00, 20),
(2003, 'Arjun', NULL, '2016-08-20', 88000.00, 40);


INSERT INTO PROJECT (PNO, PNAME, PLOC) VALUES
(501, 'Apollo', 'Bengaluru'),
(502, 'Zeus', 'Hyderabad'),
(503, 'Hermes', 'Mysuru'),
(504, 'Athena', 'Chennai'),
(505, 'Poseidon', 'Delhi');


INSERT INTO ASSIGNED_TO (EMPNO, PNO, JOB_ROLE) VALUES
(1001, 501, 'Analyst'),
(1002, 502, 'Accountant'),
(1003, 503, 'Developer'),
(1004, 504, 'Coordinator'),
(1005, 505, 'Supervisor');


INSERT INTO INCENTIVES (EMPNO, INCENTIVE_DATE, INCENTIVE_AMOUNT) VALUES
(1001, '2023-12-01', 5000.00),
(1002, '2023-11-15', 7000.00),
(1003, '2024-01-10', 6000.00),
(1004, '2024-02-20', 4500.00),
(1001, '2024-03-05', 3000.00);

-- WEEK 6

SELECT E2.ENAME AS MANAGER_NAME
FROM EMPLOYEE E1
JOIN EMPLOYEE E2 ON E1.MGR_NO = E2.EMPNO
GROUP BY E2.ENAME
HAVING COUNT(E1.EMPNO) = (
  SELECT MAX(CNT)
  FROM (
    SELECT COUNT(E1.EMPNO) AS CNT
    FROM EMPLOYEE E1
    WHERE E1.MGR_NO IS NOT NULL
    GROUP BY E1.MGR_NO
  ) AS MAX
);


SELECT M.ENAME AS MANAGER_NAME, M.SAL AS MANAGER_SAL
FROM EMPLOYEE M
JOIN EMPLOYEE E ON M.EMPNO = E.MGR_NO
GROUP BY M.ENAME, M.SAL
HAVING M.SAL > AVG(E.SAL);


SELECT E.ENAME AS SECOND_LEVEL_MANAGER, D.DNAME AS DEPARTMENT
FROM EMPLOYEE E
JOIN DEPT D ON E.DEPTNO = D.DEPTNO
WHERE E.MGR_NO IN (
  SELECT EMPNO FROM EMPLOYEE WHERE MGR_NO IS NULL
);



WITH RankedIncentives AS (
  SELECT
    EMPNO,
    INCENTIVE_AMOUNT,
    DENSE_RANK() OVER (ORDER BY INCENTIVE_AMOUNT DESC) as rnk
  FROM INCENTIVES
  -- Filtering for January 2019
  WHERE INCENTIVE_DATE >= '2019-01-01' AND INCENTIVE_DATE <= '2019-01-31'
)
SELECT E.*
FROM EMPLOYEE E
JOIN RankedIncentives RI ON E.EMPNO = RI.EMPNO
WHERE RI.rnk = 2;


SELECT E.ENAME AS EMPLOYEE_NAME, M.ENAME AS MANAGER_NAME, D.DNAME AS DEPARTMENT
FROM EMPLOYEE E
JOIN EMPLOYEE M ON E.MGR_NO = M.EMPNO
JOIN DEPT D ON E.DEPTNO = D.DEPTNO
WHERE E.DEPTNO = M.DEPTNO;
